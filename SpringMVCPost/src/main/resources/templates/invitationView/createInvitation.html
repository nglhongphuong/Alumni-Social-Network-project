

<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>T·∫°o b√†i ƒëƒÉng th√¥ng b√°o</title>
    <th:block th:replace="base :: styles"></th:block>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- head: below existing links -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/habibmhamadi/multi-select-tag@4.0.1/dist/css/multi-select-tag.min.css">
    <!-- Bootstrap 5 JS (cho alert ƒë√≥ng) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</head>
<body>
    <div th:replace="base :: header"></div>
    <main class="container">
        <div id="alertContainer"></div>
        <h1 style="text-align: center">T·∫°o b√†i ƒëƒÉng</h1>
        <div class="card" style="margin:0 auto; width:500px">
            <div class="card-body">
                <form id="invitationForm" method="post" th:action="@{/invitation/add-invitation}" th:object="${invitation}" enctype="multipart/form-data">
                    <div class="mb-3 mt-3">
                        <label for="title">Ti√™u ƒë·ªÅ</label>
                        <input type="text" class="form-control" id="title" th:field="*{title}" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ ..."  />
                    </div>

                    <div class="mb-3 mt-3">
                        <label for="title">N·ªôi dung</label>
                        <textarea type="text" class="form-control" id="title" th:field="*{content}" placeholder="Nh·∫≠p n·ªôi dung ..." rows="4"></textarea>
                    </div>

                    <div class="mb-3 mt-3">
                        <label for="admin">Ng∆∞·ªùi g·ª≠i</label>
                        <select class="form-select" id="admin" th:field="*{adminId}">
                            <option th:each="m : ${admin}"
                                    th:value="${m.userId}" 
                                    th:text="'ID: ' + ${m.userId} + ' - ' +${m.user.username}">user</option>
                        </select>
                    </div>
                    <!-- Scope selection -->
                    <div class="mb-3 mt-3">
                        <label for="reciptientScore">L·ªçc nh√≥m</label>

                        <select class="form-select" id="recipientScope" th:field="*{recipientScope}" onchange="onScopeChange()" name="recipientScope">
                            <option th:each="m : ${recipientScope}"
                                    th:value="${m}" 
                                    th:text="${m.displayName}">reciptientScore</option>
                        </select>
                    </div>

                    <!-- Role selection -->
                    <div class="mb-3 mt-3" id="roleContainer" style="display: none;">
                        <label for="roleSelect">Ch·ªçn vai tr√≤</label>
                        <select class="form-select" id="roleSelect" name="role" onchange="onRoleChange()">
                            <option th:each="r : ${roles}" 
                                    th:value="${r}" 
                                    th:text="${r.displayName}"></option>
                        </select>
                    </div>

                    <!-- User selection -->

                    <div id="userContainer">
                        <label for="userSelect">Ng∆∞·ªùi nh·∫≠n</label>
                        <select id="userSelect" name="userIds" class="form-select" multiple>
                            <!-- C√°c option s·∫Ω ƒë∆∞·ª£c t·∫°o b·∫±ng JS -->
                        </select>
                    </div>

                    <!-- D·ªØ li·ªáu ·∫©n: t·∫•t c·∫£ user theo role -->
                    <div id="userData" style="display:none;">
                        <div th:each="entry : ${allUsersByRole}">
                            <div th:attr="data-role=${entry.key}">
                                <span th:each="u : ${entry.value}" 
                                      th:attr="data-id=${u.id}, data-name=${u.username}"
                                      th:text="${u.username}"></span>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" th:field="*{id}" />

                    <div class="mb-3 mt-3">
                        <button class="btn btn-info">
                            <span th:if="${invitation.id == null}">Th√™m b√†i vi·∫øt</span>
                            <span th:unless="${invitation.id == null}">C·∫≠p nh·∫≠t b√†i vi·∫øt</span>
                        </button>
                    </div>
                </form> 
            </div>
        </div>
    </main>
    <!-- End of <body> -->
    <script src="https://cdn.jsdelivr.net/gh/habibmhamadi/multi-select-tag@4.0.1/dist/js/multi-select-tag.min.js"></script>

    <script>
                            function onScopeChange() {
                                const scope = document.getElementById("recipientScope").value;
                                console.log(scope);
                                const roleContainer = document.getElementById("roleContainer");
                                const userContainer = document.getElementById("userContainer");

                                if (scope === "ROLE_GROUP") {
                                    // Ch·ªâ l·ªçc theo role
                                    roleContainer.style.display = "block";
                                    userContainer.style.display = "none";
                                } else {
                                    // Tr∆∞·ªùng h·ª£p INDIVIDUAL ho·∫∑c CUSTOMER
                                    roleContainer.style.display = "none";
                                    userContainer.style.display = "block";

                                    // Cho INDIVIDUAL, CUSTOMER ‚Üí hi·ªÉn th·ªã all user
                                    loadUsersForAllRoles();               // Load to√†n b·ªô user
                                    const selectedRole = document.getElementById("roleSelect").value;
                                    reloadMultiSelect(selectedRole);         // G·∫Øn l·∫°i multi-select v·ªõi gi·ªõi h·∫°n n·∫øu l√† INDIVIDUAL
                                }
                            }

                            document.getElementById("roleSelect").addEventListener("change", function () {
                                const selectedRole = this.value;
                                const userContainer = document.getElementById("userContainer");
                                const userSelect = document.getElementById("userSelect");

                                // Hi·ªÉn th·ªã container
                                userContainer.style.display = "block";

                                // X√≥a c√°c option c≈©
                                userSelect.innerHTML = "";

                                // T√¨m c√°c th·∫ª span ƒë√∫ng v·ªõi role ƒë∆∞·ª£c ch·ªçn
                                const roleSpans = document.querySelectorAll(`#userData [data-role="${selectedRole}"] span`);

                                roleSpans.forEach(span => {
                                    const id = span.getAttribute("data-id");
                                    const name = span.getAttribute("data-name");

                                    // N·∫øu c√≥ id v√† name th√¨ th√™m v√†o select
                                    if (id && name) {
                                        const option = document.createElement("option");
                                        option.value = id;
                                        option.text = name;
                                        userSelect.appendChild(option);
                                    }
                                });
                            });


                            function onRoleChange() {
                                const role = document.getElementById("roleSelect").value;
                                console.log("üîç ƒêang x·ª≠ l√Ω role:", role);
                                const userContainer = document.getElementById("userContainer");
                                const userSelect = document.getElementById("userSelect");
                                userContainer.style.display = "block";
                                // Clear old options
                                userSelect.innerHTML = "";

                                // L·∫•y d·ªØ li·ªáu user t·ª´ div ·∫©n
                                // ·ª§ CODE SAI ƒê√ÇY R
                                const roleDivs = document.querySelectorAll(`#userData [data-role="${role}"] span`);
                                console.log(`‚úÖ T√¨m th·∫•y ${roleDivs.length} user cho role: ${role}`);
                                roleDivs.forEach(span => {
                                    const id = span.getAttribute("data-id");
                                    const name = span.getAttribute("data-name");
                                    console.log(`‚û°Ô∏è User ${index + 1}:`, {id, name});
                                    const option = document.createElement("option");
                                    option.value = id;
                                    option.text = name;
                                    userSelect.appendChild(option);
                                });
                                //

                                console.log("üîÅ G·ªçi l·∫°i reloadMultiSelect v·ªõi ROLE_GROUP");
                                reloadMultiSelect(role);
                                loadUsersForAllRoles();
                            }

                            let tagSelector;



                            function loadUsersForAllRoles() {
                                const userSelect = document.getElementById('userSelect');
                                userSelect.innerHTML = ''; // Clear old options

                                const allUsers = document.querySelectorAll('#userData span[data-id][data-name]');
                                allUsers.forEach(user => {
                                    const option = document.createElement('option');
                                    option.value = user.getAttribute('data-id');
                                    option.textContent = user.getAttribute('data-name');
                                    userSelect.appendChild(option);
                                });
                            }

                            function reloadMultiSelect(role) {
                                // X√≥a multi-select c≈©
                                if (tagSelector)
                                    tagSelector.destroy();

                                const config = {
                                    required: true,
                                    placeholder: 'Search tags',
                                    onChange: function (selected) {
                                        console.log('Selection changed:', selected);
                                    }
                                };

                                if (role === 'INDIVIDUAL') {
                                    config.maxSelection = 1;
                                }

                                // G·∫Øn l·∫°i MultiSelectTag
                                tagSelector = new MultiSelectTag('userSelect', config);
                            }


                            // Init ban ƒë·∫ßu
                            window.addEventListener('DOMContentLoaded', function () {
                                loadUsersForAllRoles();
                                reloadMultiSelect('ROLE_LECTURER'); // Ho·∫∑c vai tr√≤ m·∫∑c ƒë·ªãnh
                            });
                            function validateAndSubmit(surveyId) {
                                const title = document.querySelector('[name="title"]').value.trim();
                                const content = document.querySelector('[name="content"]').value.trim();
                                const recipientScope = document.querySelector('[name="recipientScope"]').value.trim();
                                const alertContainer = document.getElementById('alertContainer');
                                alertContainer.innerHTML = ''; // Xo√° th√¥ng b√°o c≈©

                                if (!title || !content || !recipientScope) {
                                    alertContainer.innerHTML = `
                        <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        <strong>‚ö†Ô∏è C·∫£nh b√°o!</strong> Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin tr∆∞·ªõc khi ti·∫øp t·ª•c.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="ƒê√≥ng"></button>
                        </div>
                        `;
                                    return;

                                }

                                alertContainer.innerHTML = `
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                        ‚úÖ <strong>Th√†nh c√¥ng!</strong> ƒêang chuy·ªÉn ƒë·∫øn trang th√™m c√¢u h·ªèi...
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="ƒê√≥ng"></button>
                        </div>
                        `;
                                // ƒê·ª£i 2 gi√¢y r·ªìi submit form
                                setTimeout(() => {
                                    document.getElementById('invitationForm').submit();
                                }, 2000);

                            }

    </script>

    <div th:replace="base :: footer"></div>
</body>
</html>
